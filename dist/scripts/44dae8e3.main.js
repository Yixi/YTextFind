"use strict";function prepareFiles(a){UI.sendMessage("ReadFile"),Util._readFiles(a).then(function(a){console.log(a),UI.sendMessage("ReadFileDone",a),g_Files=a,UI.sendMessage("MakeInputEditable")})}function readyToSearch(){var a=$.trim($("#keywordsInput").val());a.length>0&&Util.searchKeyWords(a,g_Files).then(function(a){UI.process("done"),console.log(a),UI.result(a)},function(){},function(a){UI.process(a)})}!function(){var a=function(a,b){function c(){var a=arguments,c=f._thens.shift();c&&(a=c.comp.apply(b,a),a&&(a._thens=f._thens))}function d(){var a=arguments,c=f._thens.shift();c&&c.err&&(a=c.err.apply(b,a),a&&(a._thens=f._thens))}function e(){var a=f._thens[0];a&&a.prog&&a.prog.apply(b,arguments)}var f=this;this._thens=[],setTimeout(function(){a.call(b,c,d,e)},0)};a.prototype.then=function(a,b,c){return a instanceof Function&&this._thens.push({comp:a,err:b,prog:c}),this},a.prototype.done=function(a){return a instanceof Function&&this._thens.push({comp:a,err:function(a){throw a}}),null},a.prototype.cancel=function(a){this._thens.length=0,a instanceof Function&&a()},a.join=function(){var b=arguments,c=b.length,d=0,e=[];return new a(function(a,f,g){for(var h=0;c>h;h++)!function(h){b[h].then(function(){e[h]=arguments.length<=1?arguments[0]:arguments,d++,g(d),d==c&&a.apply(this,e)},function(){var a=Array.prototype.slice.call(arguments);a.push("error in function "+h),f.apply(this,a)})}(h)})},a.any=function(){var b=arguments,c=b.length,d=!1;return new a(function(a){for(var e=0;c>e;e++)b[e].done(function(){d||(d=!0,a.apply(this,arguments))})})},a.as=function(b){return new a(function(a){a(b)})},a.sleep=function(b){return new a(function(a){setTimeout(function(){a()},parseInt(b))})},window.YPro=window.YPromise=a}();var Util={_readFiles:function(a){return new YPro(function(b,c,d){var e=a.target.files,f=[],g=0,h=e.length;if(e)for(var i,j=0;i=e[j];j++){var k=new FileReader;k.onload=function(a,c){return function(e){g++,d(g),f[a]={name:c.name,type:c.type,size:c.size,content:e.target.result},g==h&&b(f)}}(j,i),k.readAsText(i)}})},searchKeyWords:function(a,b){return new YPro(function(c,d,e){var f=b.length,g=[];a=a.split(" "),console.log(a);for(var h=0;f>h;h++){var i=b[h].content.split("\n");g[h]={},g[h].__name=b[h].name,g[h].key={};for(var j=0,k=a.length;k>j;j++)g[h].key[a[j]]=0;for(var l=0,m=i.length;m>l;l++){e("process file "+b[h].name+" line "+l);for(var n=i[l],j=0,k=a.length;k>j;j++)g[h].key[a[j]]+=n.split(a[j]).length-1}}c(g)})}},UI={process:function(a){$("#log").html(a)},result:function(a){var b="无结果";a.length>0&&(b=UI.buildTable(a)),$("#result").html(b)},buildTable:function(a){var b=[],c='<table class="table table-hover table-striped">';c+="<thead><tr><th>#</th>";for(var d in a[0].key)b.push(d),c+="<th>"+d+"</th>";c+="</tr></thead>",c+="<tbody>";for(var e=0,f=a.length;f>e;e++){c+="<tr><td>"+a[e].__name+"</td>";for(var g=0,h=b.length;h>g;g++)c+="<td>"+a[e].key[b[g]]+"</td>";c+="</tr>"}return c+="</tbody>",c+="</table>"},showFiles:function(a){var b=$("#fileCount"),c=$("#fileListArea");b.html("已选择"+a.length+"个文件：");for(var d="",e=0,f=a.length;f>e;e++)d+='<h6><span class="glyphicon glyphicon-file"></span>'+a[e].name+"<small>"+a[e].content.slice(0,30)+"...</small></h6>";c.html(d)},makeInput:function(){$("#keywordsInput,#keywordsInputDone").removeAttr("disabled"),$("#keywordsInput").focus()},sendMessage:function(a,b){switch(a){case"ReadFile":break;case"ReadFileDone":UI.showFiles(b);break;case"MakeInputEditable":UI.makeInput()}}},g_Files=null;$(function(){document.getElementById("fileSelect").addEventListener("change",prepareFiles,!1),$("#keywordsInputDone").on("click",readyToSearch),$("#keywordsInput").on("keydown",function(a){13==a.keyCode&&readyToSearch()}),$("#fileButton").on("click",function(){$("#fileSelect").click()})});